name: circuits-smoke

on:
  push:
    paths:
      - 'circuits/**'
      - '.github/workflows/circuits-smoke.yml'
  pull_request:
    paths:
      - 'circuits/**'

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install repo deps
        run: |
          yarn install --frozen-lockfile

      - name: Reset Nx daemon
        run: |
          npx nx reset

      - name: Build shared library
        run: |
          npx nx run shared:build

      - name: Build circuits TypeScript
        working-directory: circuits
        run: |
          yarn build:ts

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Download verification key from S3 (if available)
        working-directory: circuits
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          # Create zkey directory if it doesn't exist
          mkdir -p zkey

          # Try to download verification key from S3 (fail silently if not available)
          if [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "Attempting to download verification key from S3..."
            aws s3 cp s3://${{ secrets.S3_BUCKET_NAME || 'lvp-circuits-artifacts' }}/verification_key.json zkey/verification_key.json || {
              echo "Verification key not found in S3, skipping verification check"
              echo "This is expected for development/feature branches"
            }
          else
            echo "AWS credentials not configured, skipping S3 download"
            echo "This is expected for development/feature branches"
          fi

      - name: Verification key consistency check (conditional)
        working-directory: circuits
        run: |
          # Only run verification check if the key is available
          if [ -f zkey/verification_key.json ]; then
            echo "Running verification key consistency check..."
            npx ts-node --files scripts/check-vk-onchain.ts
          else
            echo "Skipping verification key consistency check - key not available"
            echo "This is expected for development/feature branches without S3 access"
          fi

      - name: Run ZKP smoke test (lightweight)
        working-directory: circuits
        env:
          HOLDER_NAME: 'CI Test'
          LICENSE_NUMBER: 'CI000'
          EXAM_ID: 'CI_TEST'
          ACHIEVEMENT_LEVEL: 'Passed'
          ISSUED_DATE: '2024-01-01'
          EXPIRY_DATE: '2025-01-01'
          ISSUER: 'CI'
          HOLDER_DOB: '1990-01-01'
          NULLIFIER: '0x1'
          PRIVATE_KEY: '0x2'
        run: |
          # Run lightweight ZKP smoke test: generate proof only (no full setup/on-chain verify)
          echo "Running ZKP smoke test (lightweight)..."

          # Check if we have the necessary artifacts for ZKP testing
          if [ -f zkey/verification_key.json ]; then
            echo "Verification key available, running full ZKP smoke test..."
            yarn ci-local:gen-proof
          else
            echo "Verification key not available, skipping ZKP smoke test"
            echo "This is expected for development/feature branches without S3 access"
            echo "ZKP functionality will be tested in the main compile-circuits workflow"
          fi
